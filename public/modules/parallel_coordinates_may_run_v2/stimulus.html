<!DOCTYPE html>
<html>
<head>
  <title>Parallel Coordinates</title>
</head>

<body>
<div id= "par_coord_stimulus_timer"> </div>
<div id="wrapper" style="display:flex; flex-direction:row; justify-content: center;">
<div id="par_coord_stimulus">
  <div id="video-wrap">
    <video controls width="800" id="video">
      <!-- <source src="video_load.php" type="video/mp4"> -->
      Your browser does not support the video tag.
  </video>
  </div>
</div>
<div id="instructions">
	<p>
		This parallel coordinates plot presents a multivariate analysis of the classic Iris dataset. The dataset has four numerical variables,  
    shown as four distinct axes in the plot: sepal length, sepal width, petal length, and petal width.  

    A single polyline represents an individual data point across multiple variables. The values for a given data point are represented as the intersection of the polyline at each axis. 
    The polylines in this plot are color-coded by three iris species. The blue lines for Iris setosa, the magenta lines for Iris virginica, and the orange lines for Iris versicolor. 
	</p>
	<p>
    Parallel coordinates enable us to explore the relative differences and similarities among the three Iris species across the four variables in the dataset. 
In addition, the plot reveals relationships between the variables across all data points. For example, there is a noticeable negative relationship between Sepal Length and Sepal Width, as indicated by the intersecting "X" pattern of the lines. 
This pattern shows that when Sepal Length increases, Sepal Width generally decreases. In contrast, Petal Length and Petal Width demonstrate a positive relationship through the parallel arrangement of the lines, meaning that as one variable increases, the other tends to increase as well.
	</p>
</div>
</div>

<script> 
function debounce(func, wait, immediate) {
    let timeout;
    return function() {
        const context = this, args = arguments;
        const later = function() {
            timeout = null;
            if (!immediate) func.apply(context, args);
        };
        const callNow = immediate && !timeout;
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
        if (callNow) func.apply(context, args);
    };
}

(function() {
  var data = {};
  var answers = {};

  init();
  
  function init(){

	data.par_coord_stimulus = null;

    //start timer
  experimentr.attachTimer('#par_coord_stimulus_timer', 320, function(){
    if(experimentr.get_current() == 'modules/parallel_coordinates_may_run_v2/stimulus.html'){ 
      experimentr.endTimer('par_coord_stimulus_timer');
      
      experimentr.addData(data);
      experimentr.next();
    }
  });
    // d3.select('.class-wrapper').node().innerHTML = experimentr.condition() === 1 ? `<div>TESTINGGGG</div>` : `<object data="modules/task_1_crait/crait_vis.svg" width="auto" height="460"> </object>`;
    if(experimentr.condition() === 1){

      d3.select('#instructions').remove();

      data.playCount = 0;

      let vid =  d3.select('#video-wrap').select('#video');
      let source = vid.append('source')
        .attr('src', 'video_load.php')
        .attr('type', 'video/mp4');  // Ensure the correct type is specified

      let caption = vid.append('track')
        .attr('src', 'modules/parallel_coordinates_may_run_v2/captions.vtt')
        .attr('label', 'English')
        .attr('kind', 'captions')
        .attr('srclang', "en-us")
        .attr('default', true);

      // document.addEventListener('DOMContentLoaded', function() {
      vid.node().addEventListener('play', function() {
      data.playCount++;
      console.log('Video has been played ' + data.playCount + ' times');
      
      });
      
      // Variable to track if the user is currently seeking
      data.seek_record = []
      let seeking = false;

      // Debounced seeking event handler
      const handleSeeking = debounce(function() {
        if (!seeking) {
          data.seek_record.push([vid.node().currentTime]);
          seeking = true;
        }
      }, 150);  // Adjust the debounce time as needed

      vid.node().addEventListener('seeking', handleSeeking);

      // Listener for when seeking ends
      vid.node().addEventListener('seeked', function() {
        if (seeking && data.seek_record.length > 0) {
          data.seek_record[data.seek_record.length - 1].push(vid.node().currentTime);
          let direction = (vid.node().currentTime - data.seek_record[data.seek_record.length - 1][0] > 0) ? "forward" : "backward";
          data.seek_record[data.seek_record.length - 1].push(direction);
         
          seeking = false;
        }
      });
      
      // // Listener for when seeking starts
      // vid.node().addEventListener('seeking', function() {
      //   if(seeking === false){
      //     seekKeeper.push([vid.node().currentTime])
      //     seeking = true;
      //   }
      // });

      // // Listener for when seeking ends
      // vid.node().addEventListener('seeked', function() {
      //   seekKeeper[seekKeeper.length - 1].push(vid.node().currentTime, vid.node().currentTime - seekKeeper[seekKeeper.length - 1] > 0 ? "forward" : "backward")
      //   seeking = false;
      // });

    }else{
      d3.select('#video-wrap').remove();
      d3.select('#vid-controls').remove();
      let ob = d3.select('#par_coord_stimulus').append('object');
      ob.attr('data', "modules/parallel_coordinates_may_run_v2/parallel_coord_new.svg"); 
      ob.attr('width', 'auto');
      ob.attr('height', '400px');
      d3.select('#wrapper').style('display', 'flex').style('flex-direction', 'row').style('align-items', 'center')
      d3.select("#instructions").style('padding-left', '20px');
    }

  	//overrides onNext from experimentr
    d3.select('#next-button')
      .on('click', function(){
        if(confirm("Are you sure you want to move on to the questions? \nYou won't be able to go back.")){
          console.log('PRESSED YES');
          experimentr.endTimer('par_coord_stimulus_timer');
          data.used_next = true;
          experimentr.addData(data);
          experimentr.next();   
        }
          // experimentr.addData(data);
          // experimentr.next();
      });
    
    experimentr.startTimer('par_coord_stimulus_timer');
    experimentr.release();
  }

}());
</script>
</body>
</html>
